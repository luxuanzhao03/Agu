<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>运维与事件治理看板</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&family=Noto+Sans+SC:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/ui/ops-dashboard/styles.css" />
  </head>
  <body>
    <div class="bg-layer"></div>
    <main class="page">
      <header class="hero" data-animate>
        <div>
          <p class="eyebrow">A股半自动交易辅助系统</p>
          <h1>运维 + 事件治理看板</h1>
          <p class="sub">作业 | SLA | 告警 | 事件NLP | 回放工作台</p>
        </div>
        <div class="hero-actions">
          <div class="hero-links">
            <a href="/ui/">主界面</a>
            <a href="/trading/workbench">投研工作台</a>
          </div>
          <button id="refreshBtn" type="button">刷新</button>
          <button id="syncSlaBtn" type="button" class="secondary">同步 SLA 告警</button>
          <p id="lastUpdated">最近更新时间：-</p>
        </div>
      </header>

      <div id="errorBanner" class="error-banner hidden"></div>

      <section class="kpi-grid" data-animate>
        <article class="kpi-card">
          <p>作业运行次数（24h）</p>
          <h2 id="kpiRuns24h">-</h2>
        </article>
        <article class="kpi-card">
          <p>调度器 SLA 违约数</p>
          <h2 id="kpiJobSlaBreaches">-</h2>
        </article>
        <article class="kpi-card">
          <p>连接器 SLA 严重告警</p>
          <h2 id="kpiConnectorSlaCritical">-</h2>
        </article>
        <article class="kpi-card">
          <p>连接器 SLA 未恢复</p>
          <h2 id="kpiConnectorSlaOpen">-</h2>
        </article>
        <article class="kpi-card">
          <p>连接器 SLA 升级中</p>
          <h2 id="kpiConnectorSlaEscalatedOpen">-</h2>
        </article>
        <article class="kpi-card">
          <p>未确认严重告警</p>
          <h2 id="kpiCriticalAlerts">-</h2>
        </article>
        <article class="kpi-card">
          <p>事件覆盖标的（30d）</p>
          <h2 id="kpiEventSymbols">-</h2>
        </article>
      </section>

      <section class="panel" data-animate>
        <div class="panel-head">
          <h3>事件覆盖总览</h3>
          <p id="coverageMeta">-</p>
        </div>
        <div class="coverage-grid">
          <div class="coverage-cards">
            <article><p>事件总量</p><h4 id="coverageTotal">-</h4></article>
            <article><p>正向事件</p><h4 id="coveragePositive">-</h4></article>
            <article><p>负向事件</p><h4 id="coverageNegative">-</h4></article>
            <article><p>覆盖数据源</p><h4 id="coverageSources">-</h4></article>
          </div>
          <div class="coverage-chart-wrap">
            <div id="coverageChart" class="coverage-chart"></div>
          </div>
        </div>
      </section>

      <section class="panel" data-animate>
        <div class="panel-head">
          <h3>连接器健康与积压</h3>
          <p>检查点 / 新鲜度 / 待重试 / 死信</p>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>连接器</th>
                <th>来源</th>
                <th>最近运行</th>
                <th>状态</th>
                <th>新鲜度(分钟)</th>
                <th>待重试</th>
                <th>死信</th>
                <th>检查点</th>
              </tr>
            </thead>
            <tbody id="connectorRows"></tbody>
          </table>
        </div>
      </section>

      <section class="panel" data-animate>
        <div class="panel-head">
          <h3>连接器多源矩阵健康</h3>
          <p>多源容灾健康评分 + 当前自动切换状态</p>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>连接器</th>
                <th>来源键</th>
                <th>类型</th>
                <th>角色</th>
                <th>健康分</th>
                <th>有效分</th>
                <th>连续失败</th>
                <th>成功次数</th>
                <th>最近成功</th>
                <th>最近错误</th>
              </tr>
            </thead>
            <tbody id="sourceHealthRows"></tbody>
          </table>
        </div>
      </section>

      <section class="panel" data-animate>
        <div class="panel-head">
          <h3>连接器 SLA 违约与升级状态机</h3>
          <p id="connectorSlaSummaryMeta">-</p>
        </div>
        <div class="split-grid">
          <div class="table-wrap">
            <h4>SLA 违约列表</h4>
            <table>
              <thead>
                <tr>
                  <th>连接器</th>
                  <th>违约类型</th>
                  <th>阶段</th>
                  <th>严重级别</th>
                  <th>新鲜度</th>
                  <th>待重试</th>
                  <th>死信</th>
                  <th>说明</th>
                </tr>
              </thead>
              <tbody id="connectorSlaRows"></tbody>
            </table>
          </div>
          <div class="table-wrap">
            <h4>未恢复状态</h4>
            <table>
              <thead>
                <tr>
                  <th>连接器</th>
                  <th>违约类型</th>
                  <th>阶段</th>
                  <th>严重级别</th>
                  <th>重复次数</th>
                  <th>升级</th>
                  <th>最近出现</th>
                  <th>最近发出</th>
                </tr>
              </thead>
              <tbody id="connectorSlaStateRows"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section class="panel" data-animate>
        <div class="panel-head">
          <h3>NLP 规则集与漂移监控</h3>
          <p>命中率 / 分值分布 / 回测贡献 / 反馈漂移</p>
        </div>
        <div class="monitor-grid">
          <article class="monitor-card">
            <p>当前规则集</p>
            <h4 id="nlpActiveRuleset">-</h4>
          </article>
          <article class="monitor-card">
            <p>最新风险等级</p>
            <h4 id="nlpLatestRisk">-</h4>
          </article>
          <article class="monitor-card">
            <p>最新快照</p>
            <h4 id="nlpLatestSnapshot">-</h4>
          </article>
          <article class="monitor-card">
            <p>命中率变化趋势</p>
            <h4 id="nlpTrendHitRate">-</h4>
          </article>
          <article class="monitor-card">
            <p>分值变化趋势</p>
            <h4 id="nlpTrendScore">-</h4>
          </article>
          <article class="monitor-card">
            <p>贡献变化趋势</p>
            <h4 id="nlpTrendContribution">-</h4>
          </article>
          <article class="monitor-card">
            <p>反馈极性趋势</p>
            <h4 id="nlpTrendFeedbackPolarity">-</h4>
          </article>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>时间</th>
                <th>规则集版本</th>
                <th>命中率变化</th>
                <th>分值变化</th>
                <th>贡献变化</th>
                <th>反馈极性</th>
                <th>反馈类型</th>
                <th>告警</th>
              </tr>
            </thead>
            <tbody id="nlpSnapshotRows"></tbody>
          </table>
        </div>
      </section>

      <section class="panel" data-animate>
        <div class="panel-head">
          <h3>SLO 消耗率历史</h3>
          <p>连接器可靠性 + NLP 漂移治理预算消耗</p>
        </div>
        <div class="monitor-grid">
          <article class="monitor-card">
            <p>连接器消耗(W)</p>
            <h4 id="connectorSloLatestWarn">-</h4>
          </article>
          <article class="monitor-card">
            <p>连接器消耗(C)</p>
            <h4 id="connectorSloLatestCritical">-</h4>
          </article>
          <article class="monitor-card">
            <p>NLP消耗(W)</p>
            <h4 id="nlpSloLatestWarn">-</h4>
          </article>
          <article class="monitor-card">
            <p>NLP消耗(C)</p>
            <h4 id="nlpSloLatestCritical">-</h4>
          </article>
        </div>
        <div class="split-grid">
          <div>
            <h4>连接器消耗趋势</h4>
            <div id="connectorSloChart" class="coverage-chart"></div>
          </div>
          <div>
            <h4>NLP消耗趋势</h4>
            <div id="nlpSloChart" class="coverage-chart"></div>
          </div>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>窗口结束</th>
                <th>运行次数</th>
                <th>运行成功率</th>
                <th>连接器消耗(W)</th>
                <th>连接器消耗(C)</th>
                <th>NLP消耗(W)</th>
                <th>NLP消耗(C)</th>
              </tr>
            </thead>
            <tbody id="sloHistoryRows"></tbody>
          </table>
        </div>
      </section>

      <section class="panel" data-animate>
        <div class="panel-head">
          <h3>作业与调度器 SLA</h3>
          <p>近期作业运行与调度器违约</p>
        </div>
        <div class="split-grid">
          <div class="table-wrap">
            <h4>近期作业运行</h4>
            <table>
              <thead>
                <tr>
                  <th>运行ID</th>
                  <th>作业ID</th>
                  <th>状态</th>
                  <th>开始时间</th>
                </tr>
              </thead>
              <tbody id="runRows"></tbody>
            </table>
          </div>
          <div class="table-wrap">
            <h4>调度器 SLA 违约</h4>
            <table>
              <thead>
                <tr>
                  <th>作业</th>
                  <th>类型</th>
                  <th>严重级别</th>
                  <th>说明</th>
                </tr>
              </thead>
              <tbody id="slaRows"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section class="panel" data-animate>
        <div class="panel-head">
          <h3>未确认告警</h3>
          <p>风险 / SLA / 治理链路</p>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>时间</th>
                <th>严重级别</th>
                <th>来源</th>
                <th>内容</th>
              </tr>
            </thead>
            <tbody id="alertRows"></tbody>
          </table>
        </div>
      </section>

      <section class="panel" data-animate>
        <div class="panel-head">
          <h3>值班回调时间线</h3>
          <p>事件 ACK / 工单同步 / 回调审计轨迹</p>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>时间</th>
                <th>服务商</th>
                <th>事件单</th>
                <th>工单</th>
                <th>状态</th>
                <th>确认</th>
                <th>备注</th>
              </tr>
            </thead>
            <tbody id="oncallRows"></tbody>
          </table>
        </div>
      </section>

      <section id="replay-workbench" class="panel" data-animate>
        <div class="panel-head">
          <h3>回放处理工作台</h3>
          <p>失败条目人工修复 + 选择性重放</p>
        </div>
        <div class="workbench-controls">
          <label>
            连接器
            <select id="wbConnectorSelect"></select>
          </label>
          <label>
            状态
            <select id="wbStatusFilter">
              <option value="PENDING">PENDING</option>
              <option value="DEAD">DEAD</option>
              <option value="REPLAYED">REPLAYED</option>
              <option value="ALL">ALL</option>
            </select>
          </label>
          <label>
            错误关键词
            <input id="wbErrorKeyword" type="text" placeholder="包含..." />
          </label>
          <button id="loadFailuresBtn" type="button">加载失败列表</button>
          <button id="selectAllFailuresBtn" type="button" class="secondary">全选/反选</button>
          <button id="replaySelectedBtn" type="button">重放选中项</button>
          <button id="repairReplaySelectedBtn" type="button">保存并重放选中项</button>
        </div>
        <p id="wbActionResult" class="muted">-</p>
        <div class="workbench-grid">
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>选择</th>
                  <th>ID</th>
                  <th>状态</th>
                  <th>重试次数</th>
                  <th>下次重试</th>
                  <th>最近错误</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="wbFailureRows"></tbody>
            </table>
          </div>
          <div class="workbench-editor">
            <p id="wbSelectedMeta" class="muted">请选择一行后编辑 payload。</p>
            <label>raw_record (JSON)</label>
            <textarea id="wbRawEditor" rows="8" spellcheck="false"></textarea>
            <label>event (JSON)</label>
            <textarea id="wbEventEditor" rows="8" spellcheck="false"></textarea>
            <label>修复说明</label>
            <input id="wbRepairNote" type="text" placeholder="说明修复了什么" />
            <label class="inline">
              <input id="wbResetRetry" type="checkbox" /> 将 retry_count 重置为 0
            </label>
            <button id="saveRepairBtn" type="button">保存修复</button>
          </div>
        </div>
        <div class="table-wrap">
          <h4>重放结果</h4>
          <table>
            <thead>
              <tr>
                <th>失败ID</th>
                <th>状态</th>
                <th>说明</th>
              </tr>
            </thead>
            <tbody id="wbReplayResultRows"></tbody>
          </table>
        </div>
      </section>
    </main>

    <script src="/ui/ops-dashboard/app.js"></script>
  </body>
</html>
