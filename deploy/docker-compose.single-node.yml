services:
  trading-assistant:
    build:
      context: ..
      dockerfile: deploy/docker/Dockerfile
    container_name: trading-assistant
    ports:
      - "8000:8000"
    environment:
      ENV: prod
      LOG_LEVEL: INFO
      DATA_PROVIDER_PRIORITY: akshare,tushare
      TUSHARE_TOKEN: ${TUSHARE_TOKEN:-}
      AUDIT_DB_PATH: /var/lib/trading/audit.db
      SNAPSHOT_DB_PATH: /var/lib/trading/snapshot.db
      REPLAY_DB_PATH: /var/lib/trading/replay.db
      STRATEGY_GOV_DB_PATH: /var/lib/trading/strategy_gov.db
      LICENSE_DB_PATH: /var/lib/trading/license.db
      JOB_DB_PATH: /var/lib/trading/job.db
      ALERT_DB_PATH: /var/lib/trading/alert.db
      EVENT_DB_PATH: /var/lib/trading/event.db
      AUTH_ENABLED: ${AUTH_ENABLED:-false}
      AUTH_HEADER_NAME: X-API-Key
      AUTH_API_KEYS: ${AUTH_API_KEYS:-}
      OPS_SCHEDULER_ENABLED: ${OPS_SCHEDULER_ENABLED:-true}
      OPS_SCHEDULER_TICK_SECONDS: ${OPS_SCHEDULER_TICK_SECONDS:-30}
      OPS_SCHEDULER_TIMEZONE: ${OPS_SCHEDULER_TIMEZONE:-Asia/Shanghai}
      OPS_JOB_SLA_GRACE_MINUTES: ${OPS_JOB_SLA_GRACE_MINUTES:-15}
      OPS_JOB_RUNNING_TIMEOUT_MINUTES: ${OPS_JOB_RUNNING_TIMEOUT_MINUTES:-120}
    volumes:
      - ../data:/var/lib/trading
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8000/health', timeout=3).read()"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 20s
    restart: unless-stopped
